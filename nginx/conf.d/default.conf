server {
    listen 8880;
    server_name cdnsky.ultraplus.click;

    access_log /home/container/naccess.log;
    error_log  /home/container/nerror.log warn;

    root /home/container/webroot;
    index index.php index.html index.htm;
    charset utf-8;

    # HSTS (aplica aunque TLS termine en Cloudflare; el header pasa al navegador)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;

    # Gzip básico para HTML/CSS/JS/SVG/JSON
    gzip on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;

    # Límite real de subida (Nginx)
    client_max_body_size 200m;
    client_body_timeout 120s;
    sendfile off;

    # Restaurar IP real detrás de Cloudflare
    real_ip_header CF-Connecting-IP;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;

    location / {
        client_max_body_size 200m;               # redundante pero seguro
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Zona de ficheros servidos (CDN) con CORS y cacheo largo
    location ^~ /uploads/ {
        # Nunca listar directorios
        autoindex off;

        # CORS (permitir hotlink desde cualquier dominio si te interesa)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Accept" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range" always;

        # Cache agresiva (nombres aleatorios -> seguros de cachear)
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        add_header X-Content-Type-Options nosniff always;

        # Sólo permitir lectura (uploads reales van a upload.php)
        limit_except GET HEAD OPTIONS { deny all; }

        # Preflight
        if ($request_method = OPTIONS) { return 204; }

        try_files $uri =404;
    }

    # Seguridad: nunca ejecutar PHP dentro de /uploads
    location ~* ^/uploads/.*\.php$ { return 404; }

    # PHP-FPM
    location ~ \.php$ {
        client_max_body_size 200m;               # aplica también en PHP
        try_files $uri =404;
        fastcgi_pass unix:/home/container/tmp/php-fpm.sock;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        fastcgi_intercept_errors off;
        fastcgi_buffer_size 64k;
        fastcgi_buffers 8 64k;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;

        # Si no usas .user.ini, puedes forzarlo aquí:
        # fastcgi_param PHP_VALUE "upload_max_filesize=200M \n post_max_size=210M";
    }

    # Limpieza
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    location ~ /\.ht  { deny all; }
    location ~ /\.git { deny all; }
}

# (Opcional) Redirige cualquier otro host a tu nuevo dominio
# server {
#     listen 8080;
#     server_name _;
#     return 301 https://cdnsky.ultraplus.click$request_uri;
# }
